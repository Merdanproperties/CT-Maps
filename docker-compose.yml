# CT Maps full stack - single command: docker compose up
# Browser -> frontend:3000 (proxy) -> backend:8000 -> postgres:5432 (inside Docker)
#
# Postgres is published on host port 5433 (not 5432) so host-run imports hit Docker
# and do not conflict with local Postgres on 5432. Backend container uses postgres:5432 internally.
#
# Source is mounted so code changes are visible without rebuilding:
# - Backend: --reload so edits restart the API
# - Frontend: Vite HMR so edits hot-reload in the browser

services:
  postgres:
    image: postgis/postgis:15-3.4
    environment:
      POSTGRES_USER: ctmaps
      POSTGRES_PASSWORD: ctmaps
      POSTGRES_DB: ct_properties
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ctmaps -d ct_properties"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    ports:
      - "5432:5432"

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql+psycopg2://ctmaps:ctmaps@postgres:5432/ct_properties
    volumes:
      - ./backend:/app
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval: 20s
      timeout: 15s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          memory: 256M

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    environment:
      VITE_PROXY_TARGET: http://backend:8000
      # Do not set VITE_MAPBOX_* here so env_file (frontend/.env) provides them; otherwise ${VAR:-} overrides with empty
      VITE_MAP_PROVIDER: ${VITE_MAP_PROVIDER:-auto}
    env_file:
      - ./frontend/.env
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/index.html:/app/index.html
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "3000:3000"

volumes:
  postgres_data:
